name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov radon
        
    - name: Run tests with warnings as errors
      run: |
        pytest tests/ -W error --tb=short
        
    - name: Generate coverage report
      run: |
        pytest tests/ --cov=app --cov-report=xml --cov-report=term
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install pylint and radon
      run: |
        python -m pip install --upgrade pip
        pip install pylint radon
        
    - name: Run pylint
      run: |
        pylint app/*.py --fail-under=9.5 --rcfile=.pylintrc || echo "Pylint score below 9.5"
        
    - name: Check cognitive complexity
      run: |
        radon cc app/ -s -n C
        if [ $? -eq 0 ]; then
          echo "✅ All functions below complexity threshold"
        else
          echo "⚠️ Some functions exceed recommended complexity"
          exit 1
        fi

  coverage-check:
    name: Coverage Threshold
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        
    - name: Check coverage threshold
      run: |
        pytest tests/ --cov=app --cov-report=term --cov-fail-under=85

  safety-audit:
    name: Safety-Critical Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest radon
        
    - name: Verify emergency shutdown tests
      run: |
        pytest tests/test_main.py::test_die_shuts_down_heaters_immediately -v
        pytest tests/test_main.py::test_die_whistle_is_mandatory -v
        pytest tests/test_main.py::test_die_e_stop_force_close_only -v
        
    - name: Verify watchdog tests
      run: |
        pytest tests/test_safety.py::test_watchdog_logic_overheat -v
        pytest tests/test_safety.py::test_watchdog_dry_boil -v
        pytest tests/test_safety.py::test_watchdog_superheater_overheat -v
        pytest tests/test_safety.py::test_watchdog_power_loss -v
        pytest tests/test_safety.py::test_watchdog_dcc_signal_loss -v
        
    - name: Verify servo safety tests
      run: |
        pytest tests/test_actuators.py::test_emergency_bypass_mode -v
        pytest tests/test_actuators.py::test_slew_rate_limiting -v

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test, quality, coverage-check, safety-audit]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify package structure
      run: |
        test -f app/__init__.py || exit 1
        test -f app/main.py || exit 1
        test -f app/config.py || exit 1
        test -f app/sensors.py || exit 1
        test -f app/actuators.py || exit 1
        test -f app/dcc_decoder.py || exit 1
        test -f app/physics.py || exit 1
        test -f app/safety.py || exit 1
        test -f app/ble_uart.py || exit 1
        test -f app/ble_advertising.py || exit 1
        echo "✅ All required modules present"
        
    - name: Verify documentation
      run: |
        test -f README.md || exit 1
        test -f CHANGELOG.md || exit 1
        test -f docs/DEPLOYMENT.md || exit 1
        test -f docs/TROUBLESHOOTING.md || exit 1
        test -f docs/CV.md || exit 1
        test -f docs/FUNCTIONS.md || exit 1
        test -f docs/capabilities.md || exit 1
        echo "✅ All documentation present"
        
    - name: Check version
      run: |
        python -c "from app import get_version; print(f'Version: {get_version()}')"

  status-report:
    name: Generate Status Report
    runs-on: ubuntu-latest
    needs: [test, quality, coverage-check, safety-audit, build]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov radon
        
    - name: Generate comprehensive report
      run: |
        echo "# CI/CD Status Report" > status.md
        echo "" >> status.md
        echo "**Build Date:** $(date)" >> status.md
        echo "**Branch:** ${{ github.ref_name }}" >> status.md
        echo "**Commit:** ${{ github.sha }}" >> status.md
        echo "" >> status.md
        
        echo "## Test Results" >> status.md
        pytest tests/ --tb=no -q >> status.md 2>&1 || true
        echo "" >> status.md
        
        echo "## Coverage Report" >> status.md
        pytest tests/ --cov=app --cov-report=term >> status.md 2>&1 || true
        echo "" >> status.md
        
        echo "## Complexity Analysis" >> status.md
        radon cc app/ -s >> status.md 2>&1 || true
        echo "" >> status.md
        
        cat status.md
        
    - name: Upload status report
      uses: actions/upload-artifact@v4
      with:
        name: ci-status-report
        path: status.md
